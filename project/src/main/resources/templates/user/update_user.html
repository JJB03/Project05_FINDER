<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layout/company_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>

        /* 이 친구들이 버튼 변경하게 하는 코드입니다.*/
           .btn-male, .btn-female {
           padding: 10px 10px;
           margin: 5px;
           color: black;
           background-color: #EDEDED;
           cursor: pointer;
       }

       .btn-male.selected, .btn-female.selected {
           background-color: #007bff;
           color: white;
       }
   </style>
    <title>기업 정보 수정</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body layout:fragment="content">

    
    <div class="container-fluid container">
        <div style="display: flex; flex-direction: column; margin-left: 100px; margin-bottom: 50px;">
            <th:block sec:authorize="hasRole('ROLE_COMPANY')">
                <strong style="font-size: 45px; margin-bottom: 15px;">기업 정보</strong>
                <strong style="font-size: 19px;">모두가 주인이 되는 문화를 통해, 꿈을 현실로 만듭니다.</strong>
            </th:block>
            <th:block sec:authorize="!hasRole('ROLE_COMPANY') and hasRole('ROLE_USER')">
                <strong style="font-size: 45px; margin-bottom: 15px;">내 정보</strong>
                <strong style="font-size: 19px;">모두가 주인이 되는 문화를 통해, 꿈을 현실로 만듭니다.</strong>
            </th:block>
        </div>

        <div class="row justify-content-center" style="padding: 0 40px 0 40px;">
            <th:block sec:authorize="hasRole('ROLE_COMPANY')">
            <nav class="col-12 col-sm-12 col-lg-3 sidebar">
                <div style="margin: 15px 0 45px 15px;">
                    <strong style="font-size: 24px;">
                        마이페이지
                    </strong>
                </div>
                <ul class="nav flex-column ul-header">
                    <li class="li-header">
                        <strong class="fs-5">기업 정보</strong>
                    </li>
                    <li class="nav-item">
                        <a href="/company/introduce_com" class="job-item-link nav-link fw-normal fs-6">
                            <div style="background-color: #fff; border-radius: 8px;" class="d-flex gap-2 p-2 ps-2">
                                <div>
                                    <img src="/img/home.png" alt="x">
                                </div>
                                <div>
                                    기업 소개
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/user/update_user" class="job-item-link nav-link fw-normal fs-6">
                            <div style="background-color: #fff; border-radius: 8px;" class="d-flex gap-2 p-2 ps-2">
                                <div>
                                    <img src="/img/Registration.png" alt="x">
                                </div>
                                <div>
                                    담당자 정보 수정
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/company/credit/credit_list_com" class="job-item-link nav-link fw-normal fs-6">
                            <div style="background-color: #fff; border-radius: 8px;" class="d-flex gap-2 p-2 ps-2">
                                <div>
                                    <img src="/img/CreditCard.png" alt="x">
                                </div>
                                <div>
                                    결제 내역
                                </div>
                            </div>
                        </a>
                    </li>
                </ul>
                <ul class="nav flex-column ul-header">
                    <li class="li-header">
                        <strong class="fs-5">채용공고 관리</strong>
                    </li>
                    <li class="nav-item">
                        <a href="/recruit/post_jobs_com" class="job-item-link nav-link fw-normal fs-6">
                            <div style="background-color: #fff; border-radius: 8px; " class="d-flex gap-2 p-2 ps-2">
                                <div>
                                    <img src="/img/list.png" alt="x">
                                </div>
                                <div>
                                    채용공고 등록
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/recruit/posted_jobs_com" class="job-item-link nav-link fw-normal fs-6">
                            <div style="background-color: #fff; border-radius: 8px; " class="d-flex gap-2 p-2 ps-2">
                                <div>
                                    <img src="/img/list.png" alt="x">
                                </div>
                                <div>
                                    등록한 채용공고
                                </div>
                            </div>
                        </a>
                    </li>
                </ul>
                <ul class="nav flex-column ul-header">
                    <li class="li-header">
                        <strong class="fs-5">이력서 관리</strong>
                    </li>
                    <li class="nav-item">
                        <a href="/recruit/recruit_list_com" class="job-item-link nav-link fw-normal fs-6">
                            <div style="background-color: #fff; border-radius: 8px; " class="d-flex gap-2 p-2 ps-2">
                                <div>
                                    <img src="/img/Documents.png" alt="x">
                                </div>
                                <div>
                                    제출된 이력서
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/company/score_com" class="job-item-link nav-link fw-normal fs-6">
                            <div style="background-color: #fff; border-radius: 8px; " class="d-flex gap-2 p-2 ps-2">
                                <div>
                                    <img src="/img/Documents.png" alt="x">
                                </div>
                                <div>
                                    AI 간편 평가
                                </div>
                            </div>
                        </a>
                    </li>
                </ul>
            </nav>
        </th:block>

        <th:block sec:authorize="!hasRole('ROLE_COMPANY') and hasRole('ROLE_USER')">
            <nav class="col-12 col-md-12 col-lg-3 sidebar">
                <div style="margin: 15px 0 45px 15px;">
                    <strong style="font-size: 24px;">
                        마이페이지
                    </strong>
                </div>
                <ul class="nav flex-column ul-header">
                    <li class="li-header">
                        <strong class="fs-5">내 정보</strong>
                    </li>
                    <li class="nav-item">
                        <a href="/user/update_user" class="job-item-link nav-link fw-normal fs-6">
                            <div style="background-color: #fff; border-radius: 8px;" class="d-flex gap-2 p-2 ps-2">
                                <div>
                                    <img src="/img/Registration.png" alt="x">
                                </div>
                                <div>
                                    내 정보 수정
                                </div>
                            </div>
                        </a>
                    </li>
                </ul>
                <ul class="nav flex-column ul-header">
                    <li class="li-header">
                        <strong class="fs-5">채용공고 관리</strong>
                    </li>
                    <li class="nav-item">
                        <a href="/recruit/applied_jobs_user" class="job-item-link nav-link fw-normal fs-6">
                            <div style="background-color: #fff; border-radius: 8px; " class="d-flex gap-2 p-2 ps-2">
                                <div>
                                    <img src="/img/list.png" alt="x">
                                </div>
                                <div>
                                    지원한 채용공고
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/recruit/new_jobs_user" class="job-item-link nav-link fw-normal fs-6">
                            <div style="background-color: #fff; border-radius: 8px; " class="d-flex gap-2 p-2 ps-2">
                                <div>
                                    <img src="/img/list.png" alt="x">
                                </div>
                                <div>
                                    최근 본 채용공고
                                </div>
                            </div>
                        </a>
                    </li>
                </ul>
                <ul class="nav flex-column ul-header">
                    <li class="li-header">
                        <strong class="fs-5">이력서 관리</strong>
                    </li>
                    <li class="nav-item">
                        <a href="/resume/cv_list_user" class="job-item-link nav-link fw-normal fs-6">
                            <div style="background-color: #fff; border-radius: 8px; " class="d-flex gap-2 p-2 ps-2">
                                <div>
                                    <img src="/img/Documents.png" alt="x">
                                </div>
                                <div>
                                    나의 이력서
                                </div>
                            </div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/resume/cv_create_user" class="job-item-link nav-link fw-normal fs-6">
                            <div style="background-color: #fff; border-radius: 8px; " class="d-flex gap-2 p-2 ps-2">
                                <div>
                                    <img src="/img/Documents.png" alt="x">
                                </div>
                                <div>
                                    이력서 작성
                                </div>
                            </div>
                        </a>
                    </li>
                </ul>
            </nav>
        </th:block>

         <main class="col-12 col-md-12 col-lg-8 main-content d-flex justify-content-end align-items-start">
                <div class="job-listings d-flex flex-column align-items-center">
                    <div class="job-header w-100">
                        <th:block sec:authorize="hasRole('ROLE_COMPANY')">
                            <div style="padding: 15px;"><strong>담당자 정보 수정</strong></div>
                        </th:block>
                        <th:block sec:authorize="!hasRole('ROLE_COMPANY') and hasRole('ROLE_USER')">
                            <div style="padding: 15px;"><strong>내 정보 수정</strong></div>
                        </th:block>
                    </div>

                    <!-- 비밀번호 변경 폼 -->
                    <form id="PwForm" action="/company/update_com_pw" method="post" class="register-form" style="width:100% !important; border-radius: 12px; background-color: #FAFAFA;">
                        <!-- CSRF 토큰 -->
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <div id="id" class="d-flex flex-column">
                            <!-- 사용자 아이디 -->
                            <div for="username" class="userid">아이디</div>
                            <input type="text" id="username" th:value="${session.user.userId}" name="username" placeholder="사용자 아이디"
                                readonly>
                            <br>
                            <!-- 현재 비밀번호 확인 -->
                            <div for="password" class="userpw" style="width: 115px; text-align: center;">비밀번호 변경</div>
                            <input type="password" id="userBeforePw" name="userBeforePw" placeholder="현재 비밀번호 입력" required autoComplete="off"
                            >
                            <button type="button" onclick="PW_Confirm()" id="confirm-password-btn" class="btn-in-short align-self-end" style="margin-right: 10px; background-color: var(--long-btn-color);">확인</button>
                        </div>

                        <div id="passwordChange" class="d-flex flex-column" style="display: none !important;">
                            
                            <input type="password" id="userPw" name="userPw" placeholder="8~16자리/영문 대소문자,숫자,특수문자 조합" required autoComplete="off">
                            <input type="password" id="confirm-password" name="confirm-password" required placeholder="비밀번호 확인" autoComplete="off">                                    
                            <button onclick="validatePasswordConfirmation()" id="UpdatePw" type="submit" class="btn-in-short align-self-end" style="margin-right: 10px; background-color: var(--long-btn-color);">변경</button> <br>
                        </div> 

                    </form>



                    <!-- 이름/생년월일/휴대폰/이메일/기업주소 변경 폼 -->
                    <form id="InfoForm" action="/company/update_com_info" method="post" class="register-form mt-4" style="border-radius: 12px; background-color: #FAFAFA;">
                        <!-- CSRF 토큰 -->
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <input type="hidden" th:name="userNo" th:value="${session.user.userNo}">
                        <div for="name" class="username" style="width: 55px; text-align: center;">이름</div>
                        
                        <div class="gender">
                            <!-- 이름 -->
                            <input class="input-name" type="text" id="name" name="userName" th:value="${session.user.userName}" required placeholder="이름" readonly>
                            <div class="gender-btn">
                                <button type="button" class="btn-male" id="male" name="gender">남</button>
                                <button type="button" class="btn-female" id="female" name="gender">여</button>
                            </div> 
                        </div>
        
                        <div for="birthdate" class="userbirth" style="width: 84px; text-align: center;">생년월일</div>

                        <div class="birthdate">
                            <input type="date" id="startDate" th:value="${session.user.userBirth}" name="userBirth" class="keyword-main">
                        </div>


                        <div for="phone" class="userphone">휴대폰</div>
                        <div class="phone d-flex flex-column">
                            <!-- 휴대폰번호 -->
                            <input type="text" onchange="validatePhone(this)" id="phone" name="userPhone" th:value="${session.user.userPhone}" required >                            
                        </div>
        
                        <div for="email" class="useremail">
                            이메일
                        </div>
                        <div class="phone d-flex flex-column">
                            <!-- 이메일 -->
                            <input type="email" onchange="validateEmail(this)" id="email" name="userEmail" th:value="${session.user.userEmail}" required >
                        </div>

                        <!-- <div for="address" class="useraddress">
                            기업 주소
                        </div> -->
                        <div class="phone d-flex flex-column">
                            <!-- 기업주소 -->
                            <!-- <input type="text" id="address" name="comAddress" th:value="${session.user.company.comAddress}" required > -->

                            <!-- 폼 전송버튼 -->
                            <button id="UpdateUserComInfo" type="submit" class="btn-in-short align-self-end" style="margin-right: 10px; background-color: var(--long-btn-color);">변경</button>
                        </div>
                    </form>

                    

                </div>
            </main>
        </div>

    </div>

    <script>
        
        // 성별 표시 ⭕
        $(function() { // 페이지가 로드되기 전에 실행시킬 코드들
            var gender = "[[${session.user.userGender}]]";

            if(gender=="남자"){
                $('#male').css('backgroundColor', 'var(--sub-color)')
                $('#male').css('color', 'white')
            }else{
                $('#female').css('backgroundColor', 'var(--sub-color)')
                $('#female').css('color', 'white')
            }

            $('#PwForm').on('keydown', function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                }
            });

        });


        // 현재 비밀번호 확인 ⭕
        function PW_Confirm() {

            // 💍 CSRF TOKEN
            var csrfToken = "[[${_csrf.token}]]";
            let url = "/company/update_com_pw_confirm";
            var userBeforePw = document.getElementById('userBeforePw').value;

            // jQuery 로 AJAX 요청
            $.ajax({
                type: 'POST',               // 요청 메소드 - GET, POST, PUT, DELETE
                url: url,                   // 요청 URL
                data: JSON.stringify({      // 요청 데이터를 JSON 문자열로 변환
                    password: userBeforePw
                }),
                contentType: 'application/json',     // 요청 데이터 타입
                dataType: 'json',                   // 응답 데이터 타입
                beforeSend: function(xhr) {
                    // 💍 CSRF 토큰을 요청 헤더에 추가
                    xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);
                },
                // 요청 성공 
                success: function(response, status) {
                    // response : 응답 데이터
                    // status   : 응답 상태
                    if(response) {
                        alert('비밀번호가 일치합니다.');
                        $('#passwordChange').css('display','flex') // 현재 비밀번호 확인 후 변경 폼 보여주기
                    } else {
                        alert('비밀번호가 일치하지 않습니다.');
                        $('#passwordChange').css('display','none !important')
                    }
                },
                // 에러
                error: function(xhr, status) {
                    // xhr      : XMLHttpRequest 객체
                    // status   : 응답 상태
                    alert('에러 발생');
                }
            });
        }

        // 비밀번호 유효성 검사 ⭕
        function validatePasswordConfirmation() {

            var password = document.getElementsByName("userPw")[0].value;
            var confirmPassword = document.getElementsByName("confirm-password")[0].value;
            var UpdatePw = $('#UpdatePw');
            console.log(password + "+" + confirmPassword)

            // 비밀번호가 8~16자리이고 영문 대소문자, 숫자, 특수문자를 모두 포함하는지 검사
            if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[~!@#$%^&*()_+`\-={}[\]:;"'<>,.?\\/]).{8,16}$/.test(password)) {
                document.getElementsByName("userPw")[0].setCustomValidity(
                    "비밀번호는 8~16자리의 영문 대소문자, 숫자, 특수문자를 모두 포함해야 합니다.");
            } else {
                document.getElementsByName("userPw")[0].setCustomValidity("");


                // 비밀번호와 확인 비밀번호가 일치하는지 검사
                if (password != confirmPassword) {
                    document.getElementsByName("confirm-password")[0].setCustomValidity("비밀번호와 일치하지 않습니다.");
                    return
                } else {
                    document.getElementsByName("confirm-password")[0].setCustomValidity("");
                    alert('비밀번호가 변경되었습니다.') // 비밀번호 변경 완료
                }
            }
        }



        // 기업회원 정보 수정 알림 ⭕
        $(document).ready(function() {
            // 폼 제출 이벤트 핸들러 설정
            $("#InfoForm").on("submit", function(event) {
                event.preventDefault(); // 기본 제출 이벤트를 방지
                
                // 각 입력 필드 객체를 찾아 함수에 전달
                var emailInput = document.getElementById('email');
                var phoneInput = document.getElementById('phone');

                validateEmail(emailInput);
                validatePhone(phoneInput);

                // 두 유효성 검사가 모두 통과했는지 확인
                if(emailInput.checkValidity() && phoneInput.checkValidity()) {
                    alert("정보가 변경되었습니다.");
                    this.submit(); // 유효성 검사 통과 후 폼 제출
                }
            });
        });

        // 이메일 유효성 검사 ⭕
        function validateEmail(input) {
            var email = input.value;
            if(!/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/i.test(email)) {
                input.setCustomValidity("이메일 형식이 아닙니다.");
            } else {
                input.setCustomValidity(""); // 유효성 오류 메시지를 클리어
            }
            input.reportValidity();
        }

        // 전화번호 유효성 검사 ⭕
        function validatePhone(input) {
            var phone = input.value;
            if (phone.length !== 11 || !/^[0-9]+$/.test(phone)) {
                input.setCustomValidity("휴대전화번호 형식이 아닙니다.");
            } else {
                input.setCustomValidity(""); // 유효성 오류 메시지를 클리어
            }
            input.reportValidity();
        }
        
    </script>

</body>

</html>