<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.finder.project.resume.mapper.ResumeMapper">

<resultMap id="CvResultMap" type="com.finder.project.resume.dto.Resume">
    <id property="cvNo" column="cv_no"/>
    <result property="coverLetter" column="cover_letter"/>
    <result property="cvTitle" column="cv_title"/>
    <result property="cvRegDate" column="cv_reg_date"/>
    <result property="cvUpdDate" column="cv_upd_date"/>
    
    <!-- education mapping -->
    <collection property="educationList" ofType="com.finder.project.resume.dto.Education">
        <id property="educationNo" column="education_no"/>
        <result property="university" column="university"/>
        <result property="major" column="major"/>
        <result property="universityStatus" column="university_status"/>
        <result property="cvNo" column="cv_no"/>
    </collection>

    <!-- employment_history mapping -->
    <collection property="employmentHistoryList" ofType="com.finder.project.resume.dto.EmploymentHistory">
        <id property="employmentHistoryNo" column="employment_history_no"/>
        <result property="organization" column="organization"/>
        <result property="duration" column="duration"/>
        <result property="duties" column="duties"/>
        <result property="cvNo" column="cv_no"/>
    </collection>
</resultMap>

  <!-- 이력서 리스트 조회 -->
  <select id="resumelist" resultMap="CvResultMap">
      SELECT c.*, eh.*, ed.*
      FROM cv c
      INNER JOIN employment_history eh ON c.cv_no = eh.cv_no
      INNER JOIN education ed ON c.cv_no = ed.cv_no
  </select>

  <!-- 이력서 상세 조회 -->
  <select id="select" resultMap="CvResultMap">
    SELECT c.*, eh.*, ed.*
      FROM cv c
      INNER JOIN employment_history eh ON c.cv_no = eh.cv_no
      INNER JOIN education ed ON c.cv_no = ed.cv_no
    WHERE c.cv_no = #{cvNo}
  </select>

  <!-- 이력서 작성 -->
<insert id="create" parameterType="Resume" >
    <!-- Insert into cv -->
    INSERT INTO `cv` (`user_no`, `cover_letter`, `cv_title`)
    VALUES (#{userNo}, #{coverLetter}, #{cvTitle});

    <!--  LAST_INSERT_ID() 함수를 사용하여 cv_no를 가져와서 교육 및 경력 기록의 cv_no에 삽입 -->
    <selectKey keyProperty="cvNo" resultType="int" order="AFTER">
        SELECT LAST_INSERT_ID() AS cvNo
    </selectKey>
    
    <!-- Insert into employment_history -->
    <foreach collection="employmentHistoryList" item="employHistory">
        INSERT INTO `employment_history` (`organization`, `duration`, `duties`, `cv_no`)
        VALUES (#{employHistory.organization}, #{employHistory.duration}, #{employHistory.duties}, #{cvNo})
    </foreach>

    <!-- Insert into education -->
    <foreach collection="educationList" item="education">
        INSERT INTO `education` (`cv_no`, `university`, `major`, `university_status`)
        VALUES (#{cvNo}, #{education.university}, #{education.major}, #{education.universityStatus})
    </foreach>
</insert>

  <!-- 이력서 삭제 -->
  <delete id="delete">
    DELETE FROM cv
    WHERE cv_no = #{cv_no}
  </delete>

</mapper>